# üîß Configura√ß√£o da Stack: Evolution API + Chatwoot + ERP

**√öltima Atualiza√ß√£o:** 13 de Fevereiro de 2026  
**Servidor:** 84.247.143.180  
**SSH:** `sshpass -p 'Henrico9516' ssh root@84.247.143.180`

---

## üìã Arquitetura Atual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WhatsApp        ‚îÇ     ‚îÇ    EVOLUTION API      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   CHATWOOT      ‚îÇ
‚îÇ  (Usu√°rio)       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    v2.3.0 :8080       ‚îÇ     ‚îÇ   v3.3.1 :3000  ‚îÇ
‚îÇ                  ‚îÇ     ‚îÇ    Instance: alraerp   ‚îÇ     ‚îÇ   Account: 1    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ Webhook
                                   ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  SUPABASE PROXY      ‚îÇ
                         ‚îÇ  whatsapp-proxy v3   ‚îÇ
                         ‚îÇ  ‚Üí Salva no Supabase ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ
                                   ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  ERP (React App)     ‚îÇ
                         ‚îÇ  CRM + IA Analysis   ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîë Credenciais

| Item | Valor |
|------|-------|
| **Evolution API Key** | `mypassy` |
| **Chatwoot Account ID** | `1` |
| **Chatwoot Token** | `pgh3rRR6ZLirSnzdnuQZbhNV` |
| **Instance Name** | `alraerp` |
| **Chatwoot Login** | `henrico.pierdona@gmail.com` / `Henrico9516` |
| **SSH** | `root@84.247.143.180` / `Henrico9516` |

---

## üîß Status dos Servi√ßos

| Servi√ßo | Status | Porta |
|---------|--------|-------|
| Evolution API v2.3.0 | ‚úÖ Online | 8080 |
| Chatwoot v3.3.1 | ‚úÖ Online | 3000 |
| PostgreSQL 15 | ‚úÖ Online | 5432 |
| Redis 6.2 | ‚úÖ Online | 6379 |

---

## ‚öôÔ∏è Configura√ß√£o da Inst√¢ncia `alraerp`

### Settings
```json
{
  "syncFullHistory": true,
  "groupsIgnore": true,
  "readMessages": false,
  "readStatus": false,
  "alwaysOnline": false,
  "rejectCall": false
}
```

### Integra√ß√£o Chatwoot (Nativa)
```json
{
  "enabled": true,
  "accountId": "1",
  "token": "pgh3rRR6ZLirSnzdnuQZbhNV",
  "url": "http://rails:3000",
  "signMsg": false,
  "reopenConversation": true,
  "conversationPending": false,
  "importContacts": true,
  "importMessages": true,
  "daysLimitImportMessages": 365,
  "nameInbox": "WhatsApp",
  "mergeBrazilContacts": true,
  "autoCreate": true
}
```

### Webhook (ERP/Supabase)
```json
{
  "url": "https://greotjobqprtmrprptdb.supabase.co/functions/v1/whatsapp-proxy",
  "events": [
    "MESSAGES_UPSERT",
    "MESSAGES_UPDATE",
    "SEND_MESSAGE",
    "CONTACTS_UPSERT",
    "CONTACTS_UPDATE",
    "CONNECTION_UPDATE"
  ]
}
```

---

## üöÄ Como Conectar o WhatsApp

### Pelo ERP (Recomendado)
1. Acesse **Configura√ß√µes > WhatsApp** no ERP
2. Clique em **"Gerar QR Code"**
3. Escaneie o QR Code com o celular (WhatsApp > Aparelhos Conectados > Conectar)
4. Aguarde a sincroniza√ß√£o autom√°tica (pode levar alguns minutos para hist√≥rico)

### Via API direta
```bash
# Gerar QR Code
curl -s -H "apikey: mypassy" http://84.247.143.180:8080/instance/connect/alraerp

# Verificar status
curl -s -H "apikey: mypassy" http://84.247.143.180:8080/instance/connectionState/alraerp
```

---

## üì• O que acontece ao conectar

1. **Evolution API** conecta ao WhatsApp via Baileys
2. **`syncFullHistory: true`** ‚Üí Puxa TODO o hist√≥rico de mensagens do celular
3. **Chatwoot Integration** ‚Üí Automaticamente importa:
   - ‚úÖ Contatos (com merge de n√∫meros brasileiros)
   - ‚úÖ Mensagens dos √∫ltimos 365 dias
   - ‚úÖ Cria inbox "WhatsApp" automaticamente
4. **Webhook ‚Üí Supabase** ‚Üí Cada nova mensagem √© salva no banco do ERP
   - ‚úÖ Mensagens recebidas (inbound)
   - ‚úÖ Mensagens enviadas (outbound) ‚Üê NOVO: agora salva tamb√©m!
   - ‚úÖ Para an√°lise com IA
   - ‚úÖ Para exibi√ß√£o no CRM do ERP

---

## ‚ö†Ô∏è IMPORTANTE: Corre√ß√µes Aplicadas (13/02/2026)

### 1. Inst√¢ncia unificada como `alraerp`
- **Antes:** ERP usava `erp_USERID` (inst√¢ncia din√¢mica por user)
- **Depois:** ERP agora usa `alraerp` (inst√¢ncia fixa com Chatwoot configurado)
- **Arquivos alterados:** `EvolutionContext.tsx`, `whatsapp-proxy/index.ts`, `.env`

### 2. API Key corrigida para `mypassy`
- **Antes:** ERP usava fallback `Henrico9516` (incorreto)
- **Depois:** Usa `mypassy` (API key real da Evolution no Docker)

### 3. `sync_history` implementada no proxy
- **Antes:** O bot√£o "Sincronizar Agora" chamava `sync_history` mas a action n√£o existia
- **Depois:** Implementado: puxa at√© 100 chats recentes com 50 msgs cada e salva no Supabase

### 4. Mensagens `fromMe` agora salvas
- **Antes:** Webhook ignorava `data.key.fromMe` (mensagens enviadas perdidas)
- **Depois:** Salva ambos inbound e outbound com direction correto

### 5. Webhook atualizado com todos os eventos
- **Antes:** Faltavam `SEND_MESSAGE`, `CONTACTS_UPSERT`, `CONTACTS_UPDATE`
- **Depois:** Todos os 6 eventos configurados

---

## üö´ N8N (Desativado)

O N8N foi removido do fluxo para evitar duplica√ß√£o de mensagens.
A integra√ß√£o nativa Evolution‚ÜíChatwoot substitui completamente o workflow N8N.

---

## üîß Docker Compose Path
```
/opt/chatwoot_stack/docker-compose.yml
```

## üìú Comandos de Manuten√ß√£o

```bash
# SSH
sshpass -p 'Henrico9516' ssh root@84.247.143.180

# Verificar containers
docker ps --format '{{.Names}}\t{{.Status}}'

# Reiniciar Evolution apenas
cd /opt/chatwoot_stack && docker compose up -d evolution

# Logs da Evolution
docker logs -f chatwoot_stack-evolution-1 --tail 50

# Logs do Chatwoot
docker logs -f chatwoot_stack-rails-1 --tail 50

# Status da inst√¢ncia via API
curl -s -H "apikey: mypassy" http://84.247.143.180:8080/instance/connectionState/alraerp

# Verificar mensagens no Chatwoot via API
curl -s -H "api_access_token: pgh3rRR6ZLirSnzdnuQZbhNV" 'http://84.247.143.180:3000/api/v1/accounts/1/conversations?page=1'
```

## üîë Vari√°veis de Ambiente (.env do ERP)

```env
# Evolution API (WhatsApp)
VITE_EVOLUTION_API_URL=http://84.247.143.180:8080
VITE_EVOLUTION_API_KEY=mypassy
VITE_EVOLUTION_INSTANCE=alraerp
```
