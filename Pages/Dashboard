import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
  Upload, 
  FileText, 
  DollarSign, 
  Users, 
  TrendingUp,
  Settings as SettingsIcon,
  Megaphone,
  Sparkles,
  Info
} from "lucide-react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function Dashboard() {
  const [settings, setSettings] = useState(null);

  const { data: sales = [] } = useQuery({
    queryKey: ['sales'],
    queryFn: () => base44.entities.Sale.list('-created_date'),
    initialData: [],
  });

  const { data: customers = [] } = useQuery({
    queryKey: ['customers'],
    queryFn: () => base44.entities.Customer.list(),
    initialData: [],
  });

  useEffect(() => {
    const fetchSettings = async () => {
      const settingsList = await base44.entities.Settings.list();
      if (settingsList.length > 0) {
        setSettings(settingsList[0]);
      }
    };
    fetchSettings();
  }, []);

  const handleLogoUpload = async (e) => {
    const file = e.target.files[0];
    if (file) {
      try {
        const { file_url } = await base44.integrations.Core.UploadFile({ file });
        
        if (settings) {
          await base44.entities.Settings.update(settings.id, { logo_url: file_url });
        } else {
          await base44.entities.Settings.create({ logo_url: file_url });
        }
        window.location.reload();
      } catch (error) {
        console.error("Erro ao fazer upload:", error);
      }
    }
  };

  const totalRevenue = sales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
  const totalCashback = sales.reduce((sum, sale) => sum + (sale.cashback_earned || 0), 0);
  const totalSales = sales.length;
  const totalCustomers = customers.length;

  const dashboardCards = [
    {
      title: "Resumo",
      value: `${totalSales} vendas`,
      icon: FileText,
      bgColor: "bg-indigo-600",
      link: createPageUrl("Sales")
    },
    {
      title: "Pagamentos",
      value: `R$ ${totalRevenue.toFixed(2)}`,
      icon: DollarSign,
      bgColor: "bg-green-600",
      link: createPageUrl("Sales")
    },
    {
      title: "+ Cliente",
      value: `${totalCustomers} clientes`,
      icon: Users,
      bgColor: "bg-pink-600",
      link: createPageUrl("Customers")
    },
    {
      title: "Faturamento",
      value: `R$ ${totalCashback.toFixed(2)} cashback`,
      icon: TrendingUp,
      bgColor: "bg-orange-600",
      link: createPageUrl("Reports")
    },
    {
      title: "Marketing",
      value: "",
      icon: Megaphone,
      bgColor: "bg-blue-600",
      link: createPageUrl("Marketing"),
      badge: "EM BREVE"
    }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 p-4">
      <div className="max-w-4xl mx-auto space-y-4">
        {/* Logo Upload Section */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex flex-col items-center">
            {settings?.logo_url ? (
              <div className="relative group">
                <img 
                  src={settings.logo_url} 
                  alt="Logo" 
                  className="h-16 w-auto object-contain rounded-xl"
                />
                <label className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer rounded-xl flex items-center justify-center">
                  <Upload className="w-6 h-6 text-white" />
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleLogoUpload}
                    className="hidden"
                  />
                </label>
              </div>
            ) : (
              <label className="cursor-pointer border-2 border-dashed border-indigo-300 rounded-2xl p-8 hover:border-indigo-500 transition-all group">
                <div className="flex flex-col items-center text-indigo-400 group-hover:text-indigo-600 transition-colors">
                  <Upload className="w-8 h-8 mb-2" />
                  <p className="text-xs font-medium">Clique para adicionar sua logo</p>
                  <p className="text-xs mt-1 text-gray-400">PNG, JPG ou SVG</p>
                </div>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleLogoUpload}
                  className="hidden"
                />
              </label>
            )}
          </div>
        </div>

        {/* Cashback Promotion Alert */}
        <Alert className="bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-200 rounded-xl">
          <Sparkles className="h-4 w-4 text-indigo-600" />
          <AlertDescription className="ml-2">
            <div className="space-y-1">
              <h3 className="font-semibold text-indigo-900 text-sm">ðŸ’° Cashback Aumenta Faturamento!</h3>
              <p className="text-xs text-indigo-800">
                Lojas com cashback registraram aumento de <strong>20% no faturamento</strong> em 3 meses.
              </p>
              <div className="flex gap-1 mt-1">
                <Info className="w-3 h-3 text-indigo-600 mt-0.5 flex-shrink-0" />
                <p className="text-xs text-indigo-700">
                  Fonte: SEBRAE 2024
                </p>
              </div>
            </div>
          </AlertDescription>
        </Alert>

        {/* Dashboard Cards */}
        <div className="grid grid-cols-2 gap-3">
          {dashboardCards.map((card, index) => (
            <Link key={index} to={card.link}>
              <Card className="group hover:shadow-md transition-all duration-200 cursor-pointer border-0 overflow-hidden h-full bg-white rounded-xl">
                <div className="p-4">
                  <div className={`${card.bgColor} w-12 h-12 rounded-xl flex items-center justify-center mb-3 shadow-sm`}>
                    <card.icon className="w-6 h-6 text-white" />
                  </div>
                  <h3 className="text-gray-900 text-sm font-semibold mb-1">{card.title}</h3>
                  {card.badge ? (
                    <div className="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-0.5 rounded-full inline-block">
                      {card.badge}
                    </div>
                  ) : (
                    <p className="text-gray-600 text-xs">{card.value}</p>
                  )}
                </div>
              </Card>
            </Link>
          ))}
        </div>

        {/* Settings Button */}
        <div className="flex justify-center pt-2">
          <Link to={createPageUrl("Settings")}>
            <Button
              variant="ghost"
              size="icon"
              className="w-12 h-12 rounded-full bg-white hover:bg-gray-100 shadow-sm border border-gray-200"
            >
              <SettingsIcon className="w-5 h-5 text-gray-600" />
            </Button>
          </Link>
        </div>
      </div>
    </div>
  );
}